<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>网卡中断和CPU绑定问题处理 | Welcom to whmz&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="继续网关优化话题，本次整理下处理的一个CPU绑定问题。 在CPU绑定一块，有几个工具是可以使用的：  taskset - set or retrieve a process’s CPU affinity可以设定或取消某个进程的CPU亲和（我觉得叫绑定不错）。具体使用上，可以设置mask选择某个CPU核，直接给进程设定CPU编号。  set_irq_affinity - 设置网卡中断的CPU绑定关系">
<meta property="og:type" content="article">
<meta property="og:title" content="网卡中断和CPU绑定问题处理">
<meta property="og:url" content="http://whmz.github.io/2018/03/24/net-cpuset/index.html">
<meta property="og:site_name" content="Welcom to whmz&#39;s Blog">
<meta property="og:description" content="继续网关优化话题，本次整理下处理的一个CPU绑定问题。 在CPU绑定一块，有几个工具是可以使用的：  taskset - set or retrieve a process’s CPU affinity可以设定或取消某个进程的CPU亲和（我觉得叫绑定不错）。具体使用上，可以设置mask选择某个CPU核，直接给进程设定CPU编号。  set_irq_affinity - 设置网卡中断的CPU绑定关系">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2018-03-25T13:05:14.305Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="网卡中断和CPU绑定问题处理">
<meta name="twitter:description" content="继续网关优化话题，本次整理下处理的一个CPU绑定问题。 在CPU绑定一块，有几个工具是可以使用的：  taskset - set or retrieve a process’s CPU affinity可以设定或取消某个进程的CPU亲和（我觉得叫绑定不错）。具体使用上，可以设置mask选择某个CPU核，直接给进程设定CPU编号。  set_irq_affinity - 设置网卡中断的CPU绑定关系">
  
    <link rel="alternate" href="/atom.xml" title="Welcom to whmz&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Welcom to whmz&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">总结，进步，分享</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://whmz.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-net-cpuset" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/24/net-cpuset/" class="article-date">
  <time datetime="2018-03-24T11:45:05.000Z" itemprop="datePublished">2018-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      网卡中断和CPU绑定问题处理
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>继续网关优化话题，本次整理下处理的一个CPU绑定问题。</p>
<p>在CPU绑定一块，有几个工具是可以使用的：</p>
<ol>
<li><p>taskset - set or retrieve a process’s CPU affinity<br>可以设定或取消某个进程的CPU亲和（我觉得叫绑定不错）。具体使用上，可以设置mask选择某个CPU核，直接给进程设定CPU编号。</p>
</li>
<li><p>set_irq_affinity - 设置网卡中断的CPU绑定关系<br>Intel随ixgeb驱动源码一起提供的一个脚本，一般位于 ixgbe-x.x.x\scripts\set_irq_affinity。脚本根据传入的CPU核心号及网卡名，动态计算绑定关系并设置。</p>
</li>
<li><p>htop - interactive process viewer<br>可以动态、以图形方式查看各个CPU核心的负载，以及占用CPU较高的当前进程。在调试过程中，可以用来动态观察CPU核心负载，判断哪些CPU负载较高。</p>
</li>
<li><p>/proc/interrupts - 中断信息<br>可以看到当前各个中断数、以及每个CPU处理的中断数，并能根据后面几列查看是哪个网卡、队列等信息。</p>
</li>
</ol>
<h2 id="问题时间点"><a href="#问题时间点" class="headerlink" title="问题时间点"></a>问题时间点</h2><p>在网络运营中，比较经常收到用户投诉，报高峰期的上网不稳定、延迟比较大、有时间段无法连接等问题。为了排查问题，在几个高峰时间点跟踪了下CPU状态、网络负载情况，发现有几个CPU核心负载非常高，明显超出其他CPU核心，并多次达到90%以上的利用率。按之前的设置理解，Intel-82599ES网卡应该已经对数据做了Hash处理、分到各个队列去执行收发操作；set_irq_affinity也已经对各个中断做了绑定，按理说不应该出现非常不均衡的情况，除非：某些访问非常占用资源，而且这种访问在Hash意义上不均衡；CPU亲和没有均衡各个中断，导致各CPU实际处理的中断不均衡。</p>
<h2 id="原始脚本和绑定关系"><a href="#原始脚本和绑定关系" class="headerlink" title="原始脚本和绑定关系"></a>原始脚本和绑定关系</h2><p>处理流量的网关本身配置2CPU，共24核心、48线程，其中0-11，24-35为一个CPU，12-23，36-47为另一个CPU；使用了Intel-82599ES网卡，配两个万兆光模块，一进一出；在之前为了解决高峰期处理用户连接响应慢的问题，给strongswan进程绑定了40-47号CPU，给外网卡绑定了8-11+24-35共16个核心，内网卡则使用了12-23+36-39共16个核心。按原始规划，外网卡不负责数据加解密，只会收发数据，负载应该不会太高。</p>
<p>放几个脚本：</p>
<ol>
<li>set_charon_cpu.sh <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU_SET_GROUP_TASK 外部传入，目前40-47</span></span><br><span class="line"></span><br><span class="line">CPU_SET_GROUP_TASK=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">pid=`pidof charon`</span><br><span class="line">tlist=`ls /proc/<span class="variable">$&#123;pid&#125;</span>/task`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tid <span class="keyword">in</span> <span class="variable">$&#123;tlist&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  taskset -cp <span class="string">"<span class="variable">$CPU_SET_GROUP_TASK</span>"</span> <span class="variable">$tid</span></span><br><span class="line">  <span class="comment">#echo $&#123;tid&#125;    </span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>脚本获取charon进程pid，并根据pid找到关联的进程，设置相应任务的CPU</p>
<ol>
<li>set_irq_affinity<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set_irq_affinity &quot;$CPU_SET_GROUP_IDEV&quot; $IDEV</span><br><span class="line">set_irq_affinity &quot;$CPU_SET_GROUP_ODEV&quot; $ODEV</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>设置网卡中断亲和，按前述CPU核心关系设置</p>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>按分析，问题点分到了两个方向，Intel-82599ES的队列Hash是否均衡，以及CPU亲和设置是否正确。</p>
<ol>
<li>检查82599的队列Hash过程<br>翻看了<a href="https://www.intel.com/content/dam/www/public/us/en/documents/datasheets/82599-10-gbe-controller-datasheet.pdf" target="_blank" rel="noopener">Intel 82599 10 GbE Controller Datasheet</a>,其中7.1.2.7.15节，以及7.1.2.8.1节，给出了Hash函数的伪码，并给出了对应的输入情况。其中还提到，该算法来源自微软<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/rss-hashing-functions" target="_blank" rel="noopener">MSFT RSS</a>。另外，在整理这篇的时候，想到一个问题，翻看了下ixgbe驱动的README，在其中也看到些关于RSS、HASH的说法。</li>
</ol>
<p>综合起来说，HASH函数不复杂，但是参数不少，而且计算过程有几个参数随机，基本上意味着比较困难分析结果的随机性，除非做散列测试和统计。分析这个对于解决问题帮助不大，后续放弃了这个排查方向。</p>
<ol>
<li>CPU亲和设置<br>结合Hash队列的排查，想到一个问题解决办法，如果某个核心的中断数太多，给该中断指定多个CPU核心处理是否可行？</li>
</ol>
<p>为了验证这个思路，先得把CPU和中断的绑定关系找到，使用/proc/interrupts系统，获取系统的中断情况：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用grep过滤了带CPU信息的首行、以及带网卡名的所有行</span></span><br><span class="line">cat /proc/interrupts | grep -E "CPU|ens3f"&gt; inter.1.txt</span><br></pre></td></tr></table></figure></p>
<p>得到的结果比较大，基本没法分析，大致是这个样子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">          CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       CPU8       CPU9       CPU10      CPU11      CPU12      CPU13      CPU14      CPU15      CPU16      CPU17      CPU18      CPU19      CPU20      CPU21      CPU22      CPU23      CPU24      CPU25      CPU26      CPU27      CPU28      CPU29      CPU30      CPU31      CPU32      CPU33      CPU34      CPU35      CPU36      CPU37      CPU38      CPU39      CPU40      CPU41      CPU42      CPU43      CPU44      CPU45      CPU46      CPU47      </span><br><span class="line">79:          2          0          0          0          0          0          0          0          0          0          0          0  152046289          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI 2621440-edge      ens3f0-TxRx-0</span><br><span class="line">80:          0          2          0          0          0          0          0          0          0          0          0          0          0 3544103245          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI 2621441-edge      ens3f0-TxRx-1</span><br><span class="line">81:          0          0          2          0          0          0          0          0          0          0          0          0          0          0 3613272673          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI 2621442-edge      ens3f0-TxRx-2</span><br></pre></td></tr></table></figure></p>
<p>为了方便处理，先分析问题严重的网卡ens3f1，再对数据做个过滤，只留下外网卡关联的数据、CPU核心,导入到excel中，并对数据做了个标准化（数据太大，统一除1000000之后取整，方便肉眼观察）:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	CPU8	CPU9	CPU10	CPU11	CPU24	CPU25	CPU26	CPU27	CPU28	CPU29	CPU30	CPU31	CPU32	CPU33	CPU34	CPU35		</span><br><span class="line">129:	1940 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-0</span><br><span class="line">130:	0 	1958 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-1</span><br><span class="line">131:	0 	0 	1952 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-2</span><br><span class="line">132:	0 	0 	0 	1937 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-3</span><br><span class="line">133:	0 	0 	0 	0 	1882 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-4</span><br><span class="line">134:	0 	0 	0 	0 	0 	1874 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-5</span><br><span class="line">135:	0 	0 	0 	0 	0 	0 	1867 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-6</span><br><span class="line">136:	0 	0 	0 	0 	0 	0 	0 	1836 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-7</span><br><span class="line">137:	0 	0 	0 	0 	0 	0 	0 	0 	2089 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-8</span><br><span class="line">138:	0 	0 	0 	0 	0 	0 	0 	0 	0 	2110 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-9</span><br><span class="line">139:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2118 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-10</span><br><span class="line">140:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2100 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-11</span><br><span class="line">141:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	752 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-12</span><br><span class="line">142:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	962 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-13</span><br><span class="line">143:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	296 	0 	IR-PCI-MSI	ens3f1-TxRx-14</span><br><span class="line">144:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	565 	IR-PCI-MSI	ens3f1-TxRx-15</span><br><span class="line">145:	3208 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-16</span><br><span class="line">146:	0 	2788 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-17</span><br><span class="line">147:	0 	0 	3094 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-18</span><br><span class="line">148:	0 	0 	0 	3706 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-19</span><br><span class="line">149:	0 	0 	0 	0 	3429 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-20</span><br><span class="line">150:	0 	0 	0 	0 	0 	3359 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-21</span><br><span class="line">151:	0 	0 	0 	0 	0 	0 	3428 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-22</span><br><span class="line">152:	0 	0 	0 	0 	0 	0 	0 	3276 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-23</span><br><span class="line">153:	0 	0 	0 	0 	0 	0 	0 	0 	67 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-24</span><br><span class="line">154:	0 	0 	0 	0 	0 	0 	0 	0 	0 	67 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-25</span><br><span class="line">155:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	67 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-26</span><br><span class="line">156:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	68 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-27</span><br><span class="line">157:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	58 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-28</span><br><span class="line">158:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	58 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-29</span><br><span class="line">159:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	58 	0 	IR-PCI-MSI	ens3f1-TxRx-30</span><br><span class="line">160:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	59 	IR-PCI-MSI	ens3f1-TxRx-31</span><br><span class="line">161:	64 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-32</span><br><span class="line">162:	0 	64 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-33</span><br><span class="line">163:	0 	0 	63 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-34</span><br><span class="line">164:	0 	0 	0 	65 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-35</span><br><span class="line">165:	0 	0 	0 	0 	3573 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-36</span><br><span class="line">166:	0 	0 	0 	0 	0 	3288 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-37</span><br><span class="line">167:	0 	0 	0 	0 	0 	0 	3426 	0 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-38</span><br><span class="line">168:	0 	0 	0 	0 	0 	0 	0 	3692 	0 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-39</span><br><span class="line">169:	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-40</span><br><span class="line">170:	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-41</span><br><span class="line">171:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-42</span><br><span class="line">172:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-43</span><br><span class="line">173:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-44</span><br><span class="line">174:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	0 	IR-PCI-MSI	ens3f1-TxRx-45</span><br><span class="line">175:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	0 	IR-PCI-MSI	ens3f1-TxRx-46</span><br><span class="line">176:	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	0 	2 	IR-PCI-MSI	ens3f1-TxRx-47</span><br></pre></td></tr></table></figure></p>
<p>这个图已经比较明显看到了问题。其中24-27号CPU，每个都处理了三组中断，这就是在htop图形上，这三个CPU负载极高的内在原因：处理了比其他CPU多50%的中断。可这是为什么，不是已经做了均衡了吗？？</p>
<p>使用ethtool，查看下网卡的统计信息，关联之前的中断号如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">	tx	rx	</span><br><span class="line">129:	25 	202819 	ens3f1-TxRx-0</span><br><span class="line">130:	10 	200887 	ens3f1-TxRx-1</span><br><span class="line">131:	8 	197607 	ens3f1-TxRx-2</span><br><span class="line">132:	7 	199917 	ens3f1-TxRx-3</span><br><span class="line">133:	8 	200718 	ens3f1-TxRx-4</span><br><span class="line">134:	7 	200328 	ens3f1-TxRx-5</span><br><span class="line">135:	6 	198601 	ens3f1-TxRx-6</span><br><span class="line">136:	6 	199398 	ens3f1-TxRx-7</span><br><span class="line">137:	1441 	199485 	ens3f1-TxRx-8</span><br><span class="line">138:	1462 	199248 	ens3f1-TxRx-9</span><br><span class="line">139:	1525 	200840 	ens3f1-TxRx-10</span><br><span class="line">140:	1388 	199782 	ens3f1-TxRx-11</span><br><span class="line">141:	115844 	1412115 	ens3f1-TxRx-12</span><br><span class="line">142:	120249 	1310274 	ens3f1-TxRx-13</span><br><span class="line">143:	110647 	1260492 	ens3f1-TxRx-14</span><br><span class="line">144:	113217 	1346577 	ens3f1-TxRx-15</span><br><span class="line">145:	103214 	1004918 	ens3f1-TxRx-16</span><br><span class="line">146:	90486 	893424 	ens3f1-TxRx-17</span><br><span class="line">147:	90040 	918054 	ens3f1-TxRx-18</span><br><span class="line">148:	102377 	1072487 	ens3f1-TxRx-19</span><br><span class="line">149:	116699 	1087521 	ens3f1-TxRx-20</span><br><span class="line">150:	111154 	1025848 	ens3f1-TxRx-21</span><br><span class="line">151:	108431 	1076808 	ens3f1-TxRx-22</span><br><span class="line">152:	119362 	1098794 	ens3f1-TxRx-23</span><br><span class="line">153:	1484 	1 	ens3f1-TxRx-24</span><br><span class="line">154:	1454 	2 	ens3f1-TxRx-25</span><br><span class="line">155:	1505 	2 	ens3f1-TxRx-26</span><br><span class="line">156:	1515 	2 	ens3f1-TxRx-27</span><br><span class="line">157:	1317 	39 	ens3f1-TxRx-28</span><br><span class="line">158:	1317 	23 	ens3f1-TxRx-29</span><br><span class="line">159:	1261 	19 	ens3f1-TxRx-30</span><br><span class="line">160:	1315 	23 	ens3f1-TxRx-31</span><br><span class="line">161:	1398 	64 	ens3f1-TxRx-32</span><br><span class="line">162:	1442 	23 	ens3f1-TxRx-33</span><br><span class="line">163:	1391 	18 	ens3f1-TxRx-34</span><br><span class="line">164:	1436 	22 	ens3f1-TxRx-35</span><br><span class="line">165:	120044 	1133138 	ens3f1-TxRx-36</span><br><span class="line">166:	112512 	1072834 	ens3f1-TxRx-37</span><br><span class="line">167:	118807 	1070846 	ens3f1-TxRx-38</span><br><span class="line">168:	132013 	1245961 	ens3f1-TxRx-39</span><br><span class="line">169:	5 	0 	ens3f1-TxRx-40</span><br><span class="line">170:	5 	0 	ens3f1-TxRx-41</span><br><span class="line">171:	5 	0 	ens3f1-TxRx-42</span><br><span class="line">172:	5 	0 	ens3f1-TxRx-43</span><br><span class="line">173:	5 	0 	ens3f1-TxRx-44</span><br><span class="line">174:	5 	0 	ens3f1-TxRx-45</span><br><span class="line">175:	5 	0 	ens3f1-TxRx-46</span><br><span class="line">176:	5 	0 	ens3f1-TxRx-47</span><br><span class="line">LOC:			interrupts</span><br></pre></td></tr></table></figure></p>
<p>可以看到，中断较多的收发数据也同样比较多。</p>
<p>因为问题比较严重，不能让用户等着缓慢排查原因，先优先解决问题。根据目前的状况，只要把165-168四个中断从24-27号CPU上调走，大概就能将这四个核心的负载降下来。考虑上面的CPU核心绑定关系，目前0-7号还空闲，用来处理一般任务，先把4-7号CPU用起来。参考了 set_irq_affinity 的代码，<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">/bin/bash</span></span><br><span class="line"></span><br><span class="line">IRQ=$1 #168</span><br><span class="line">core=$2 #31</span><br><span class="line"></span><br><span class="line">MASK_TMP=$((1&lt;&lt;$core))</span><br><span class="line">MASK=$(printf "%X" $MASK_TMP)</span><br><span class="line"></span><br><span class="line">print $MASK</span><br><span class="line"></span><br><span class="line">printf "%s" $MASK &gt; /proc/irq/$IRQ/smp_affinity</span><br><span class="line">printf "%s %d %s -&gt; /proc/irq/$IRQ/smp_affinity\n" $IFACE $core $MASK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo ./set_irq.sh 165 4</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo ./set_irq.sh 166 5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo ./set_irq.sh 167 6</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo ./set_irq.sh 168 7</span></span><br></pre></td></tr></table></figure></p>
<p>经过这样调整后，发现24-27四个CPU核心的负载已经降下来，同时其他核心的CPU利用率也稍有提高，出口带宽也有所增加。问题应该是解决了。</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>问题大致解决了，暴漏下这些问题</p>
<ol>
<li><p>set_irq_affinity为什么对48个队列都设置了CPU核心？<br>脚本执行时，通过“ls -Ux /sys/class/net/$IFACE/device/msi_irqs”获取了当前网卡的中断号，并检查/proc/interrupts中对应中断的属性是否包含TxRx，所有列出的中断都会分配CPU。</p>
</li>
<li><p>RSS和网卡队列究竟应该是多少个？<br>按之前理解的ixgbe文档，RSS启用后，网卡应该只有16个通道，如果按16个队列、16个核心来绑定，应该是1对1，不该出现如此不均衡的情况。<br>重新阅读了ixgbe的README文档，其中RSS部分说明如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RSS</span><br><span class="line">---</span><br><span class="line">Valid Range: 0-16</span><br><span class="line">0 = Assign up to the lesser value of the number of CPUs or the number of queues</span><br><span class="line">X = Assign X queues, where X is less than or equal to the maximum number of</span><br><span class="line">queues (16 queues).</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在我们的网关配置中，设置了RSS=0 （或者因为重启该设置失效），实际的队列数为CPU核数（48队列）。另外，通过ethtool -n 选项查看对应的队列信息，也发现网卡实际启用了48个队列。</p>
<h2 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h2><ol>
<li><p>上述/proc/interrupts数据是系统启动后的总量，如果中间做过绑定更替，数据就没法准确反馈实际的中断频率。<br>可以通过获取一个时间段内的两个数据，使用excel或python脚本处理下，观察增量来确定每个中断和CPU的数据关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterFile</span><span class="params">()</span>:</span></span><br><span class="line">    fname = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,fname)</span>:</span></span><br><span class="line">        self.fname = fname</span><br><span class="line">        self.inters = dict()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parseHeadLine</span><span class="params">(self,line)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">            CPU0       CPU1       CPU46      CPU47      </span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        cpus = list()</span><br><span class="line">        cvs = line.split()</span><br><span class="line">        <span class="keyword">for</span> cv <span class="keyword">in</span> cvs:</span><br><span class="line">            cpus.append(cv.strip())</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> cpus</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parseInterLine</span><span class="params">(self,line)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        0:         39          0          0          0          0          0  IR-IO-APIC    2-edge      timer</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        itype = <span class="string">''</span></span><br><span class="line">        inters = list()</span><br><span class="line">        tval3 = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">        tmps = list()</span><br><span class="line">        cvs = line.split()</span><br><span class="line">        <span class="keyword">for</span> cv <span class="keyword">in</span> cvs:</span><br><span class="line">            tmps.append(cv.strip())</span><br><span class="line">        </span><br><span class="line">        itype = tmps[<span class="number">0</span>].strip(<span class="string">':'</span>)</span><br><span class="line">        inters = [int(val) <span class="keyword">for</span> val <span class="keyword">in</span> tmps[<span class="number">1</span>:<span class="number">-3</span>]]</span><br><span class="line">        tval3 = tmps[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (itype,inters,tval3)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parsefile</span><span class="params">(self,fname)</span>:</span></span><br><span class="line">        interinfos = dict()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(fname,<span class="string">'r'</span>) <span class="keyword">as</span> rfile:</span><br><span class="line">            lines = rfile.readlines()</span><br><span class="line">            cpus = self.parseHeadLine(lines[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines[<span class="number">1</span>:]:</span><br><span class="line">                itype,inters,tval = self.parseInterLine(line)</span><br><span class="line">                interinfos[itype] = &#123;<span class="string">'name'</span>:tval,<span class="string">'inters'</span>:inters&#125;</span><br><span class="line"></span><br><span class="line">        interinfos[<span class="string">'cpus'</span>] = cpus</span><br><span class="line">        <span class="keyword">return</span> interinfos</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self,inters)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(fname + <span class="string">'.json'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> wfile:</span><br><span class="line">            json.dump(inters,wfile)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self)</span>:</span></span><br><span class="line">        inters = self.parsefile(self.fname)</span><br><span class="line">        self.save(inters)</span><br><span class="line">        <span class="keyword">return</span> inters</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntersDiff</span><span class="params">()</span>:</span></span><br><span class="line">    ipre = <span class="keyword">None</span></span><br><span class="line">    iCur = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,pre,cur)</span>:</span></span><br><span class="line">        self.ipre = pre</span><br><span class="line">        self.iCur = cur</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">diff</span><span class="params">(self)</span>:</span></span><br><span class="line">        diffs = dict()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key,cval <span class="keyword">in</span> self.iCur.items():</span><br><span class="line">            <span class="keyword">if</span> key == <span class="string">'cpus'</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            prev = self.ipre[key]</span><br><span class="line"></span><br><span class="line">            cis = cval[<span class="string">'inters'</span>]</span><br><span class="line">            pis = prev[<span class="string">'inters'</span>]</span><br><span class="line"></span><br><span class="line">            dis = list()</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(cis)):</span><br><span class="line">                dis.append(cis[i] - pis[i])</span><br><span class="line"></span><br><span class="line">            diffs[key] = &#123;<span class="string">'name'</span>:cval[<span class="string">'name'</span>],<span class="string">'inters'</span>:dis&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> diffs</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    fname = <span class="string">'inter.1.log'</span></span><br><span class="line">    ifile = InterFile(fname)</span><br><span class="line">    pre = ifile.parse()</span><br><span class="line"></span><br><span class="line">    fname = <span class="string">'inter.2.log'</span></span><br><span class="line">    ifile = InterFile(fname)</span><br><span class="line">    cur = ifile.parse()</span><br><span class="line"></span><br><span class="line">    diffs = IntersDiff(pre,cur).diff()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'res.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> wfile:</span><br><span class="line">        cpus = cur[<span class="string">'cpus'</span>]</span><br><span class="line">        cstr = <span class="string">'iNum\t'</span> + <span class="string">'\t'</span>.join([val <span class="keyword">for</span> val <span class="keyword">in</span> cpus]) + <span class="string">'\n'</span></span><br><span class="line">        wfile.write(cstr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> inum,ival <span class="keyword">in</span> diffs.items():</span><br><span class="line">            dstr = inum + <span class="string">'\t'</span> + <span class="string">'\t'</span>.join([str(val) <span class="keyword">for</span> val <span class="keyword">in</span> ival[<span class="string">'inters'</span>]]) + <span class="string">'\t'</span> + ival[<span class="string">'name'</span>] + <span class="string">'\n'</span></span><br><span class="line">            wfile.write(dstr)</span><br></pre></td></tr></table></figure>
</li>
<li><p>网卡处理的数据包数目，ethtool -S的结果也可以用类似的脚本来处理</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://whmz.github.io/2018/03/24/net-cpuset/" data-id="cjf6t7kn30000z4wi3s4chsem" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/03/11/Strongswan-DAE/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Strongswan-DAE功能相关逻辑整理</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/24/net-cpuset/">网卡中断和CPU绑定问题处理</a>
          </li>
        
          <li>
            <a href="/2018/03/11/Strongswan-DAE/">Strongswan-DAE功能相关逻辑整理</a>
          </li>
        
          <li>
            <a href="/2018/03/10/ipmarks/">一个流量标记问题导致的限速Bug</a>
          </li>
        
          <li>
            <a href="/2018/02/25/ss-hfsc/">多用户环境下的流量标记</a>
          </li>
        
          <li>
            <a href="/2018/02/25/hello/">开始！</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 whmz?<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>